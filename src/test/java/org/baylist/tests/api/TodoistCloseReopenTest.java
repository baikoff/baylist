package org.baylist.tests.api;

import org.baylist.dto.todoist.Task;
import org.baylist.tests.BaseTest;
import org.baylist.todoist.api.Todoist;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;
import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;

public class TodoistCloseReopenTest extends BaseTest {

    @Autowired
    Todoist todoistController;

    @Test
    public void closeAndReopenTask() {
        String projectId = todoistController.getProjects().stream().filter(p -> p.getName().equals("buylist")).findFirst().orElseThrow().getId();

        Task newTask = Task.builder()
                .xyiContent("Открытая Таска")
                .xyiProjectId(projectId)
                .build();
        Task createdTask = todoistController.createTask(newTask);

        List<Task> tasksBeforeClosing = todoistController.getTasksByProject(Long.parseLong(projectId));
        Optional<Task> taskInProjectBeforeClosing = tasksBeforeClosing.stream()
                .filter(t -> t.getId().equals(createdTask.getId()))
                .findAny();
        assertThat(taskInProjectBeforeClosing).isPresent();

        todoistController.closeTask(Long.parseLong(createdTask.getId()));

        List<Task> tasksAfterClosing = todoistController.getTasksByProject(Long.parseLong(projectId));
        Optional<Task> taskInProjectAfterClosing = tasksAfterClosing.stream()
                .filter(t -> t.getId().equals(createdTask.getId()))
                .findAny();
        assertThat(taskInProjectAfterClosing).isNotPresent();

        todoistController.reopenTask(Long.parseLong(createdTask.getId()));

        List<Task> tasksAfterReopening = todoistController.getTasksByProject(Long.parseLong(projectId));
        Optional<Task> taskInProjectAfterReopening = tasksAfterReopening.stream()
                .filter(t -> t.getId().equals(createdTask.getId()))
                .findAny();
        assertThat(taskInProjectAfterReopening).isPresent();
    }
}

